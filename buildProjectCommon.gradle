//DEPLOY
task buildAndDeployAll(type: GradleBuild) {
    group "deploy"
    setTasks([
            "buildLocalArtifacts",
            "composeContainers"
    ])
}

task redeployAll(type: GradleBuild) {
    group "redeploy"
    setTasks([
            "killRmRmiAllContainersAndImages",
            "buildAndDeployAll"
    ])
}

//BUILD
task buildLocalArtifacts(type: GradleBuild) {
    group "devenv"
    setTasks([
            "cleanArtifacts",
            "buildAndCopyAppArtifacts",
            "copyMainLiquibaseScripts",
            "copyDockerFiles"
    ])
}

task cleanArtifacts(type: Delete) {
    group "deploy"
    delete "${rootDir}/artifact"
}

task copyDockerFiles(type: Copy) {
    from "${rootDir}/devops/docker/"
    into "${rootDir}/artifact/project"
}

task composeContainers(type: GradleBuild) {
    setTasks([
            "dockerBuildDbImage",
            "dockerComposeAll"
    ])
}

//DOCKER TECH TASKS
task killRmRmiAllContainersAndImages(type: GradleBuild) {
    setTasks([
            "killRmRmiDB",
            "killRmRmiApp"
    ])
}

task dockerBuildDbImage(type: Exec) {
    def isWindows = System.getProperty("os.name").toLowerCase(Locale.ROOT).contains("windows")
    def runningEnvironment = isWindows ? "cmd" : "bash"
    def parameter = isWindows ? "/c" : "-c"

    commandLine runningEnvironment, parameter, "docker build -t project-postgres-java ${rootDir}/artifact/project/db/image/"
}

task dockerComposeAll(type: Exec) {
    def isWindows = System.getProperty("os.name").toLowerCase(Locale.ROOT).contains("windows")
    def runningEnvironment = isWindows ? "cmd" : "bash"
    def parameter = isWindows ? "/c" : "-c"

    commandLine runningEnvironment, parameter, "docker-compose -f ${rootDir}/artifact/project/project.yml up -d"
}